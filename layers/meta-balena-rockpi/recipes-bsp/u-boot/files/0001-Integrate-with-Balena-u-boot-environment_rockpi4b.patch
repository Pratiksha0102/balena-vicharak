From e15258b07a967d840075d24e7a5012fa64276592 Mon Sep 17 00:00:00 2001
From: Florin Sarbu <florin@balena.io>
Date: Tue, 20 Feb 2024 11:24:00 +0000
Subject: [PATCH] Integrate with Balena u-boot environment

Upstream-Status: Inappropriate [configuration]
Signed-off-by: Florin Sarbu <florin@balena.io>
---
 configs/rock-pi-4b-rk3399_defconfig | 2 +-
 include/config_distro_bootcmd.h     | 2 +-
 include/configs/rockchip-common.h   | 1 +
 3 files changed, 3 insertions(+), 2 deletions(-)

diff --git a/configs/rock-pi-4b-rk3399_defconfig b/configs/rock-pi-4b-rk3399_defconfig
index 57f176c682..18e8fcff9d 100644
--- a/configs/rock-pi-4b-rk3399_defconfig
+++ b/configs/rock-pi-4b-rk3399_defconfig
@@ -50,7 +50,7 @@ CONFIG_CMD_MMC=y
 CONFIG_CMD_PCI=y
 CONFIG_CMD_USB=y
 # CONFIG_CMD_ITEST is not set
-# CONFIG_CMD_SETEXPR is not set
+CONFIG_CMD_SETEXPR=y
 CONFIG_CMD_CACHE=y
 # CONFIG_CMD_MISC is not set
 # CONFIG_ISO_PARTITION is not set
diff --git a/include/config_distro_bootcmd.h b/include/config_distro_bootcmd.h
index f20bc32474..a87d7b8a9b 100644
--- a/include/config_distro_bootcmd.h
+++ b/include/config_distro_bootcmd.h
@@ -388,7 +388,7 @@
 		"\0"                                                      \
 	\
 	"scan_dev_for_boot_part="                                         \
-		"part list ${devtype} ${devnum} -bootable devplist; "     \
+		"setenv devplist ${resin_root_part}; "                    \
 		"env exists devplist || setenv devplist 1; "              \
 		"for distro_bootpart in ${devplist}; do "                 \
 			"if fstype ${devtype} "                           \
diff --git a/include/configs/rockchip-common.h b/include/configs/rockchip-common.h
index a8d4e52743..6abcc8cf29 100644
--- a/include/configs/rockchip-common.h
+++ b/include/configs/rockchip-common.h
@@ -150,6 +150,7 @@
 	"fastboot usb 0;"
 #else
 #define RKIMG_BOOTCOMMAND \
+	"setenv resin_kernel_load_addr ${kernel_addr_r}; run resin_set_kernel_root; run set_os_cmdline;" \
 	"run distro_bootcmd;" \
 	"boot_android ${devtype} ${devnum};" \
 	"bootrkp;"
-- 
2.17.1

